var app=angular.module("myapp",["ui.router","ngSanitize"]);window.onload=function(){},app.config(["$stateProvider","$httpProvider","$urlRouterProvider",function(e,t,n){t.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded",e.state("login",{url:"/login",templateUrl:"login.html",controller:"loginCntrl"}).state("home",{url:"/home",templateUrl:"home.html",controller:"homeCntrl"}).state("dummy",{url:"/dummy",templateUrl:"dummy.html",controller:""}),n.otherwise("login")}]),function(e){function t(e){var t=e.charCodeAt(0);return t===r||t===m?62:t===s||t===p?63:t<l?-1:t<l+10?t-l+26+26:t<u+26?t-u:t<c+26?t-c+26:void 0}function n(e){function n(e){c[m++]=e}var o,a,r,s,l,c;if(e.length%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var u=e.length;l="="===e.charAt(u-2)?2:"="===e.charAt(u-1)?1:0,c=new i(3*e.length/4-l),r=l>0?e.length-4:e.length;var m=0;for(o=0,a=0;o<r;o+=4,a+=3)s=t(e.charAt(o))<<18|t(e.charAt(o+1))<<12|t(e.charAt(o+2))<<6|t(e.charAt(o+3)),n((16711680&s)>>16),n((65280&s)>>8),n(255&s);return 2===l?(s=t(e.charAt(o))<<2|t(e.charAt(o+1))>>4,n(255&s)):1===l&&(s=t(e.charAt(o))<<10|t(e.charAt(o+1))<<4|t(e.charAt(o+2))>>2,n(s>>8&255),n(255&s)),c}function o(e){function t(e){return a.charAt(e)}var n,o,i,r=e.length%3,s="";for(n=0,i=e.length-r;n<i;n+=3)o=(e[n]<<16)+(e[n+1]<<8)+e[n+2],s+=function(e){return t(e>>18&63)+t(e>>12&63)+t(e>>6&63)+t(63&e)}(o);switch(r){case 1:o=e[e.length-1],s+=t(o>>2),s+=t(o<<4&63),s+="==";break;case 2:o=(e[e.length-2]<<8)+e[e.length-1],s+=t(o>>10),s+=t(o>>4&63),s+=t(o<<2&63),s+="="}return s}var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i="undefined"!=typeof Uint8Array?Uint8Array:Array,r="+".charCodeAt(0),s="/".charCodeAt(0),l="0".charCodeAt(0),c="a".charCodeAt(0),u="A".charCodeAt(0),m="-".charCodeAt(0),p="_".charCodeAt(0);e.toByteArray=n,e.fromByteArray=o}("undefined"==typeof exports?this.base64js={}:exports);var FILE_RECEIVER_EMAIL="",FILE_PLACEHOLDER_INDEX="",FILE_SANDER_EMAIL="";app.run(["$window","$document","$rootScope","Notifications",function(e,t,n,o){e.onfocus=function(){o.setShowNotiFlag(!1),document.getElementById("texxt")&&document.getElementById("texxt").focus()},e.onblur=function(){o.setShowNotiFlag(!0)}}]).controller("mainCntrl",["$rootScope","$scope","Notifications",function(e,t,n){t.dynoTitle="App",t.globalData={preventExecution:!1},e.$on("$stateChangeStart",function(e,n,o,a){t.globalData.preventExecution=!1,"home"==n.name&&""==a.name&&(t.globalData.preventExecution=!0)}),n.setScope(t),n.setup(),t.requestPermission=function(){n.requestPermission()},t.showNotification=function(){n.showNotification()},t.requestPermission()}]).controller("loginCntrl",["$scope","$state","$socketservice","$window",function(e,t,n,o){e.$parent.dynoTitle="Login",e.init=function(){e.loginData={username:null,email:null}},e.doLogin=function(){var n={name:e.loginData.username,email:e.loginData.email,logintime:(new Date).getTime()},o={userdata:n};localStorage.setItem("chatBox",angular.toJson(o)),t.go("home")},e.uploadFile=function(){console.log("in ctrl");var e=document.getElementById("file");n.uploadFile(e)},e.init()}]).controller("homeCntrl",["$scope","$state","$socketservice","$timeout","$compile","$filter","Notifications","$sce",function(e,t,n,o,a,i,r,s){if(e.globalData.preventExecution)return localStorage.removeItem("chatBox"),void t.go("login");var l=["mpeg","mp3","html","png"];e.$parent.dynoTitle="Home",e.uploadFile=function(t){var a=$(t).val().substr($(t).val().lastIndexOf("\\")+1),i=a.substr(a.lastIndexOf(".")+1);l.indexOf(i)>-1?(n.uploadFile(t),e.usermessage="file:"+a,e.sendChatMessage("sendpressed")):(e.notification={username:"",message:"File type not supported.",showHide:!0},o(function(){e.notification.showHide=!1},3e3))};var c;e.init=function(){e.emojiImgPath=$.emojiarea.path||"",e.serachUser={name:"",email:""},e.chatBoxOpened=!1,e.receiver=null,e.notification={username:"",message:"",showHide:!1},null!=localStorage.getItem("chatBox")?(e.userdetails=angular.fromJson(localStorage.getItem("chatBox")).userdata,n.setupforUser(angular.fromJson(localStorage.getItem("chatBox")).userdata),n.getOnlineUsers("General")):t.go("login");var o;$(document).keydown(function(e){13==(o=e.keyCode||e.charCode)&&e.preventDefault()}),e.browseFile=function(){$("#file").trigger("click")},e.to_trusted=function(e){return s.trustAsHtml(e)},$("input[type=file]").change(function(){var t=document.getElementById("file");e.$apply(function(){e.uploadFile(t)})}),$(".emojis-plain").emojiarea({wysiwyg:!1});var a=$(".emojis-wysiwyg").emojiarea({wysiwyg:!0});c=$(".emoji-wysiwyg-editor"),a.on("change",function(t){e.usermessage=$(this).val(),13==o&&(o=void 0,e.$apply(function(){e.sendMessage("sendpressed")}))}),a.trigger("change"),e.resetModel()},e.sendMessage=function(t){c[0].innerHTML="",e.sendChatMessage(t)},e.$on("onmessage",function(t,a){if(1==a.flag&&a.email!=e.userdetails.email&&(e.notification={username:a.name,message:"has joined",showHide:!0},o(function(){e.notification.showHide=!1},3e3)),2==a.flag&&e.$apply(function(){if(e.onlineUsers)for(var t in a.onlineusers)e.onlineUsers.hasOwnProperty(t)||(e.onlineUsers[t]=a.onlineusers[t]);else e.onlineUsers=a.onlineusers}),3==a.flag){if(a.userDisconnected.emaill!=e.userdetails.email&&(e.notification={username:a.userDisconnected.name,message:"has disconnected",showHide:!0}),e.onlineUsers[a.userDisconnected.email]&&e.onlineUsers[a.userDisconnected.email].msg){var i=JSON.parse(localStorage.getItem("chatBox")).userdata,s={flag:5,email:a.userDisconnected.email,name:a.userDisconnected.name,currentUserEmail:i.email,currentUserName:i.name,msg:e.onlineUsers[a.userDisconnected.email].msg};n.sendMessages(s)}for(var l in e.onlineUsers)e.onlineUsers[l].email==a.userDisconnected.email&&e.$apply(function(){delete e.onlineUsers[l]});e.receiver&&a.userDisconnected.email==e.receiver.email&&(e.chatBoxOpened=!1),o(function(){e.notification.showHide=!1},3e3)}if(4==a.flag){var c=e.onlineUsers[a.sender.email];a.type&&"group"===a.type?r.showNotification({title:"Message",body:a.message.sender.name+" has sent a new message in "+a.sender.name}):r.showNotification({title:"Message",body:a.sender.name+" has sent a new message"}),c||(c={active:!0,msg:[],email:a.receiver.email,name:a.receiver.name,newmsgWhileInactive:!1,type:"group"},e.onlineUsers[a.sender.email]=c),c.msg?e.$apply(function(){c.msg.push(a.message)}):e.$apply(function(){c.msg=[a.message]}),e.receiver&&e.receiver.email==a.sender.email||(c.active=!1,c.newmsgWhileInactive=!0,e.$apply(function(){e.onlineUsers[a.sender.email]=c}));var u=document.getElementById("chatMessages");u.scrollTop=u.scrollHeight}if(6==a.flag){e.notification={username:a.owner.name,message:"has added you in a group "+a.name,showHide:!0},o(function(){e.notification.showHide=!1},3e3);var m={active:!1,email:a.groupId,name:a.name,newmsgWhileInactive:!1,type:a.type};e.$apply(function(){e.onlineUsers[a.groupId]=m})}if(7==a.flag){var p=a.attachment;setTimeout(function(){n.changeProgressStatusInUI(p.progress,p)})}if(8==a.flag){e.onlineUsers[a.fileInfo.receiverEmail].msg[a.fileInfo.filePlaceHolderIndex];e.onlineUsers[a.fileInfo.receiverEmail].msg[a.fileInfo.filePlaceHolderIndex].msg=a.data}}),e.startChat=function(t,n){e.chatBoxOpened=!0,e.createGroupFlag=!1;for(var o in e.onlineUsers)e.onlineUsers[o].active=!1;n.active=!0,n.newmsgWhileInactive=!1,n.msg||(n.msg=[]),e.onlineUsers[n.email]=n,e.receiver=n},e.sendChatMessage=function(t){var o=!1;if(t&&13==t.keyCode?(o=!0,t.preventDefault()):"sendpressed"===t&&(o=!0),o){var a=e.usermessage.match(/:[a-zA-Z0-9#*+)-_({}[;_]+/gi),r=e.usermessage,s=!1;if(a)for(var l=0;l<a.length;l++)for(var c=0;c<$.emojiarea.icons.length;c++){var u=a[l].toLowerCase();$.emojiarea.icons[c].icons.hasOwnProperty(u)&&(r=r.replace(a[l],'<img class="emoji-msg-img" src="'+e.emojiImgPath+"/"+$.emojiarea.icons[c].icons[u]+'">'))}if(r.indexOf("file:")>-1){s=!0;var m=r.substr(r.lastIndexOf(":")+1),p=m.replace(/^.*\./,"");m=m.replace(/ /g,"___"),m=m.replace(/\./g,"-"),FILE_RECEIVER_EMAIL=e.receiver.email,FILE_PLACEHOLDER_INDEX=e.onlineUsers[e.receiver.email].msg.length,attachmentData={type:p};r='<div class="c100 p0 small '+m+'"><span>0%</span><div class="slice">   <div class="bar"></div>   <div class="fill"></div></div></div>'}var d=i("date")(new Date,"hh:mm a"),f={flag:4,receiver:{name:e.receiver.name,email:e.receiver.email},message:{msg:r,time:d}};s&&(f.attachmentData=attachmentData),e.onlineUsers[e.receiver.email].msg.push({msg:r,sender:{name:e.userdetails.name,email:e.userdetails.email},time:d}),e.usermessage="",n.sendMessages(f);var g=document.getElementById("chatMessages");setTimeout(function(){g.scrollTop=g.scrollHeight},0)}},e.openCreateGrooupModel=function(){e.createGroupFlag=!0},e.resetModel=function(){e.createGroupModel={name:"",groupId:"",participant:[],participantEmail:[]}},e.userDropDownFlag=!1,e.$watch("searchUser",function(t,n){t!==n&&(e.userDropDownFlag=""!=t)}),e.$watch("createGroupModel.name",function(t,n){t!==n&&(e.createGroupModel.groupId=void 0===t?"":t.replace(/ /g,"_")+"@whatsis.com")}),e.addGroupParticipant=function(t){e.userDropDownFlag=!1,e.createGroupModel.participant.push(t),e.createGroupModel.participantEmail.push(t.email)},e.deleteParticipant=function(t){e.createGroupModel.participant.splice(t,1),e.createGroupModel.participantEmail.splice(t,1)},e.createGroup=function(){if(e.createGroupModel.participant.length>0){e.createGroupModel.participant.push(e.userdetails.email),e.createGroupModel.participantEmail.push(e.userdetails.email);var t={name:e.createGroupModel.name,groupdId:e.createGroupModel.groupId,participant:e.createGroupModel.participantEmail,msgSendToParticipant:"Default message",type:"group",owner:{name:e.userdetails.name,email:e.userdetails.email}},a={active:!1,email:t.groupdId,name:t.name,newmsgWhileInactive:!1,type:t.type};e.onlineUsers[t.groupdId]=a,n.createGroup(t),e.resetModel()}else e.notification={username:"",message:"Please add participant to start group",showHide:!0},o(function(){e.notification.showHide=!1},3e3)},e.init()}]).filter("myfilter",function(){return function(e,t){var n=[],o=null;return null!=localStorage.getItem("chatBox")&&(o=angular.fromJson(localStorage.getItem("chatBox")).userdata||{}),angular.forEach(e,function(e){e&&o&&e.email!=o.email&&("creategroup"!==t||"group"!==e.type)&&n.push(e)}),n}}).directive("toggleClass",function(){return{restrict:"A",link:function(e,t,n,o){t.bind("click",function(){for(var e=t.parent()[0],n=0;n<e.children.length;n++)e.children[n].setAttribute("class","ng-scope");"ng-scope"==t.attr("class")?t.addClass("active"):t.removeClass("active")})}}}),app.service("Notifications",["$rootScope",function(e){var t,n,o={},a=window,i={},r=!1,s=notify.isSupported,l={notPinned:"Pin current page in the taskbar in order to receive notifications",notSupported:"<strong>Desktop Notifications not supported!</strong> Check supported browsers table and project's GitHub page."};return o.setScope=function(e){t=e},o.setShowNotiFlag=function(e){n=e},o.setup=function(){t.notification={title:"Notification Title",body:"Notification Body",icon:"Assets/img/logo.png"},t.permissionLevel=notify.permissionLevel(),t.permissionsGranted=t.permissionLevel===notify.PERMISSION_GRANTED;try{r=a.external&&void 0!==a.external.msIsSiteMode()}catch(e){}i[notify.PERMISSION_DEFAULT]="alert",i[notify.PERMISSION_GRANTED]="alert alert-success",i[notify.PERMISSION_DENIED]="alert alert-error",l[notify.PERMISSION_DEFAULT]="<strong>Warning!</strong> Click to allow displaying desktop notifications.",l[notify.PERMISSION_GRANTED]="<strong>Success!</strong>",l[notify.PERMISSION_DENIED]="<strong>Denied!</strong>",t.status=s?i[t.permissionLevel]:i[notify.PERMISSION_DENIED],t.message=s?r?l.notPinned:l[t.permissionLevel]:l.notSupported},o.requestPermission=function(){t.permissionLevel===notify.PERMISSION_DEFAULT&&notify.requestPermission(function(){t.$apply(t.permissionLevel=notify.permissionLevel()),t.$apply(t.permissionsGranted=t.permissionLevel===notify.PERMISSION_GRANTED),t.$apply(t.status=s?i[t.permissionLevel]:i[notify.PERMISSION_DENIED]),t.$apply(t.message=s?r?l.notPinned:l[t.permissionLevel]:l.notSupported)})},o.showNotification=function(e){n&&(t.notification.title=e.title,t.notification.body=e.body,notify.createNotification(t.notification.title,{body:t.notification.body,icon:t.notification.icon}))},o}]),app.service("$socketservice",["$rootScope","$timeout",function(e,t){function n(e){switch(e.substr(e.lastIndexOf("-")+1)){case"pdf":return"fa-file-pdf-o";case"html":return"fa-html5";case"png":return"fa-file-image-o";case"txt":return"fa-file-text"}}var o={};o.fileStatus={};var a=document.location.protocol+"//"+document.location.hostname+":"+document.location.port+"/";return o.userSocket=io(a),o.uploader=new SocketIOFileClient(o.userSocket),o.setupforUser=function(e){o.userSocket.emit("newuser",btoa(angular.toJson(e)))},o.createGroup=function(e){o.userSocket.emit("creategroup",btoa(angular.toJson(e)))},o.getOnlineUsers=function(e){var t={flag:2,action:"getonlineuser",room:e};o.sendMessages(t)},o.sendMessages=function(e){o.userSocket.emit("onconversation",btoa(angular.toJson(e)))},o.userSocket.on("onmessage",function(t){try{e.$broadcast("onmessage",angular.fromJson(atob(t)))}catch(e){}}),o.uploader.on("start",function(e){}),o.uploader.on("stream",function(e){var t=Math.ceil(e.sent/e.size*100);o.fileStatus[e.name]=t,o.changeProgressStatusInUI(t,e)}),o.uploader.on("complete",function(e){o.changeProgressStatusInUI(100,e)}),o.uploader.on("error",function(e){o.fileUploadingError(e.name)}),o.uploader.on("abort",function(e){}),o.uploadFile=function(e){o.uploader.upload(e,"xxxxx")},o.changeProgressStatusInUI=function(t,o){var i=o.name;if(i=i.replace(/ /g,"___"),i=i.replace(/\./g,"-"),$("."+i).length){var r=$("."+i).attr("class").split(" ");$.each(r,function(e,t){0==t.indexOf("p")&&$("."+i).removeClass(t)}),$("."+i).addClass("p"+t),$("."+i+" span").html(t+"%")}if(100==t){var s=$("."+i).parent().eq(0),l=n(i),c=i;i=i.replace(/___/g," "),i=i.replace(/-/g,".");var u='<a href="'+a+"data/"+i+'" download><i class="fa fa-cloud-download download" aria-hidden="true"></i><i class="fa '+l+' image" aria-hidden="true" style="font-size:20px;color:#fff;"></i></a>';$(s).html(u),$("."+c).remove();var m={flag:8,fileInfo:o,data:u};e.$broadcast("onmessage",m)}},o.fileUploadingError=function(e){e=e.replace(/ /g,"___"),e=e.replace(/\./g,"-"),console.log(e);var t=$("."+e).parent().eq(0);$("."+e).remove();var o=n(e);$(t).html('<a><i class="fa fa-exclamation-triangle del" aria-hidden="true"></i><i class="fa '+o+' image" aria-hidden="true" style="font-size:20px;color:#fff;"></i></a>'),console.log($(t).parent().eq(1))},o}]);